# Supporting Custody, Staking, and Token Delivery on FLOW

## Deposits

If you will be receiving deposits of FLOW on a user's behalf you will need to support the following transaction.

## Staking

As a node operator, you first need to generate your staking key, networking address, node ID, and networking key.
You then need to determine the role of node you'll be running.

Submit a staking request using a `create_staking_request.cdc` transaction.
This will register your node in the Flow node identity table
and commit your tokens to stake during the next epoch.
This also stores a special node operator object in your account that is used for staking, unstaking,
and withdrawing rewards.

Once the new epoch starts, the tokens you have committed will be marked as staked and held in the protocol state.
At anytime you can submit a `request_unstake.cdc` transaction
which will move your tokens to the unbonding pool at the end of the current epoch.
They will sit in this pool for one (1) additional epoch,
at which point you will be able to withdraw your tokens via `withdraw_tokens.cdc` transaction.

### Staking as a Service & Delegation - Using the Staking Helper

If you do not hold tokens yourself,
but are relying on someone else to run a node on your behalf,
you can submit a staking request without tokens -
this will produce the needed node operator object mentioned above.
The node operator running your node will need to create a `StakingHelper` resource object
and store it in a third party account using the `create_staking_helper.cdc` transaction.
This transaction needs to be signed by both the node operator
and the token holder because it will store a capability in each account to access the third party `StakingHelper` resource.
This resource can also define the reward split between the node operator and token holder -
this is done via an `init` argument which is the percentage of rewards the node operator receives.
This `StakingHelper` allows you to securely transfer stake to the protocol
for those who are using a separate node operation service,
without requiring the node operator to take custody of those funds at any time.

The token holder will need to submit the `send_staking_tokens.cdc` transaction
from wherever their tokens are held, before you can take any action.
Once the token holder has escrowed their staking tokens and you have generated the required node info (staking key, networking address, node ID, and networking key), you or the token holder can submit the `create_staking_request.cdc` transaction which registers the node operator in the Flow ID Table contract and commits the token holders tokens to be staked in the next epoch.

If the `create_staking_request.cdc` transaction has been submitted, you can do a couple things:

- Remove the token holders stake via `request_unstaking.cdc` transaction
  (configuring this to require signatures from either or both parties is an available option)
- Withdraw rewards/unstaked tokens via `withdraw_tokens.cdc` transaction,
  which will deposit them into the corresponding accounts
  (this will automatically distribute the rewards to both the staker and node operator,
  as defined at creation of the `StakingHelper` resource).

## Delegating Stake

A node operator who wants to allow delegation to their node will create a public capability for delegators using the `publish_delegation.cdc` transaction.
This capability will only be valid for nodes which have already submitted a staking request and which fulfill the minimum staking requirements for that node type.
Token holders who wish to delegate to their node submit a `delegate_tokens.cdc` transaction
providing the account addresses of the node they want to delegate to.
This transaction creates a capability that the delegator stores in their account which gives them access to:

- Staking additional tokens
- Withdrawing rewards
- Requesting to unstake

If a node operator has delegators, they cannot withdraw their own tokens such that their own staked tokens would fall below the minimum requirement for that node type. This is enforced at the protocol level.

The minimum requirement for running each of the different
nodes is:

- Collector Nodes: 250,000 FLOW
- Consensus Nodes: 500,000 FLOW
- Execution Nodes: 1,250,000 FLOW
- Verification Nodes: 135,000 FLOW

The delegation logic keeps track of the amount of tokens each delegator has delegated for the node operator.
When rewards are paid out, the rewards are automatically divided
based on the proportion held by that token holder wrt to the total tokens staked.

### Supporting staking and delegating transactions

You can commit tokens to stake with the `send_staking_tokens.cdc` transaction.
These tokens are held in escrow in the `StakingHelper` resource.
You can submit an official staking request by using the `create_staking_request.cdc` transaction
which registers the node operator in the Flow ID Table contract
and commits your tokens to be staked in the next epoch.

Alternatively, you may choose to submit an `abort_stake.cdc` transaction
which will remove the tokens from escrow and return them to your account,
if called prior to the beginning of the epoch.

If the `create_staking_request.cdc` transaction has been submitted, you can do a few things:

- Add additional tokens via `stake_new_tokens.cdc` transaction
- Remove your stake via `request_unstaking.cdc` transaction, or
- Withdraw rewards/unstaked tokens via `withdraw_tokens.cdc` transaction
  (if you've participated in an earlier epoch)

### Unbonding / Withdrawing Stake

- The process for unbonding stake (removing it from the staked node)
  requires either party to initiate an unbonding request;
  which is a function call to the staking helper.

- When the request is approved by the core staking contract,
  the funds will be locked for one epoch
  and then transferred into the deposit account as set in the initial staking transaction.

## Transaction Templates

- Create staking request
- Stake new tokens
- Withdraw tokens
- Unbonding request
